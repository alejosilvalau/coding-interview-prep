from typing import List


# O(n^3) time | O(n^2) space
# n == length of the nums array
class Solution:
    def maxCoins(self, nums: List[int]) -> int:
        N = len(nums)
        new_nums = [1] + nums + [1]

        dp = [[0] * (N + 2) for _ in range(N + 2)]
        for left in range(N, 0, -1):
            for right in range(left, N + 1):
                for i in range(left, right + 1):
                    coins = new_nums[left - 1] * new_nums[i] * new_nums[right + 1]

                    coins += dp[left][i - 1] + dp[i + 1][right]
                    dp[left][right] = max(dp[left][right], coins)

        return dp[left][right]


"""
Example with internal algorithm trace and DP matrix visualization:
sol = Solution()
result = sol.maxCoins([3, 1, 5, 8])

Initial setup:
nums = [3, 1, 5, 8]
N = 4
new_nums = [1, 3, 1, 5, 8, 1]  (indices: 0, 1, 2, 3, 4, 5)

DP Matrix dimensions: (N+2) x (N+2) = 6x6
We use indices [1..4] for the actual balloons
Rows represent 'left' boundary, columns represent 'right' boundary

Initial DP matrix (all zeros):
     0    1    2    3    4    5
  ┌────┬────┬────┬────┬────┬────┐
0 │  0 │  0 │  0 │  0 │  0 │  0 │
  ├────┼────┼────┼────┼────┼────┤
1 │  0 │  0 │  0 │  0 │  0 │  0 │
  ├────┼────┼────┼────┼────┼────┤
2 │  0 │  0 │  0 │  0 │  0 │  0 │
  ├────┼────┼────┼────┼────┼────┤
3 │  0 │  0 │  0 │  0 │  0 │  0 │
  ├────┼────┼────┼────┼────┼────┤
4 │  0 │  0 │  0 │  0 │  0 │  0 │
  ├────┼────┼────┼────┼────┼────┤
5 │  0 │  0 │  0 │  0 │  0 │  0 │
  └────┴────┴────┴────┴────┴────┘

════════════════════════════════════════════════════════════

ITERATION: left=4, right=4, i=4 (balloon [8])
  coins = new_nums[3] * new_nums[4] * new_nums[5] = 5 * 8 * 1 = 40
  coins += dp[4][3] + dp[5][4] = 40 + 0 + 0 = 40
  dp[4][4] = max(0, 40) = 40

DP matrix after updating [4][4]:
     0    1    2    3    4    5
  ┌────┬────┬────┬────┬────┬────┐
0 │  0 │  0 │  0 │  0 │  0 │  0 │
  ├────┼────┼────┼────┼────┼────┤
1 │  0 │  0 │  0 │  0 │  0 │  0 │
  ├────┼────┼────┼────┼────┼────┤
2 │  0 │  0 │  0 │  0 │  0 │  0 │
  ├────┼────┼────┼────┼────┼────┤
3 │  0 │  0 │  0 │  0 │  0 │  0 │
  ├────┼────┼────┼────┼────┼────┤
4 │  0 │  0 │  0 │  0 │ 40 │  0 │ ← updated
  ├────┼────┼────┼────┼────┼────┤
5 │  0 │  0 │  0 │  0 │  0 │  0 │
  └────┴────┴────┴────┴────┴────┘

════════════════════════════════════════════════════════════

ITERATION: left=3, right=3, i=3 (balloon [5])
  coins = new_nums[2] * new_nums[3] * new_nums[4] = 1 * 5 * 8 = 40
  coins += dp[3][2] + dp[4][3] = 40 + 0 + 0 = 40
  dp[3][3] = max(0, 40) = 40

DP matrix after updating [3][3]:
     0    1    2    3    4    5
  ┌────┬────┬────┬────┬────┬────┐
0 │  0 │  0 │  0 │  0 │  0 │  0 │
  ├────┼────┼────┼────┼────┼────┤
1 │  0 │  0 │  0 │  0 │  0 │  0 │
  ├────┼────┼────┼────┼────┼────┤
2 │  0 │  0 │  0 │  0 │  0 │  0 │
  ├────┼────┼────┼────┼────┼────┤
3 │  0 │  0 │  0 │ 40 │  0 │  0 │ ← updated
  ├────┼────┼────┼────┼────┼────┤
4 │  0 │  0 │  0 │  0 │ 40 │  0 │
  ├────┼────┼────┼────┼────┼────┤
5 │  0 │  0 │  0 │  0 │  0 │  0 │
  └────┴────┴────┴────┴────┴────┘

════════════════════════════════════════════════════════════

ITERATION: left=3, right=4 (balloons [5, 8])
  i=3: coins = 1*5*1 + dp[3][2] + dp[4][4] = 5 + 0 + 40 = 45
       dp[3][4] = max(0, 45) = 45
  i=4: coins = 1*8*1 + dp[3][3] + dp[5][4] = 8 + 40 + 0 = 48
       dp[3][4] = max(45, 48) = 48

DP matrix after updating [3][4]:
     0    1    2    3    4    5
  ┌────┬────┬────┬────┬────┬────┐
0 │  0 │  0 │  0 │  0 │  0 │  0 │
  ├────┼────┼────┼────┼────┼────┤
1 │  0 │  0 │  0 │  0 │  0 │  0 │
  ├────┼────┼────┼────┼────┼────┤
2 │  0 │  0 │  0 │  0 │  0 │  0 │
  ├────┼────┼────┼────┼────┼────┤
3 │  0 │  0 │  0 │ 40 │ 48 │  0 │ ← updated
  ├────┼────┼────┼────┼────┼────┤
4 │  0 │  0 │  0 │  0 │ 40 │  0 │
  ├────┼────┼────┼────┼────┼────┤
5 │  0 │  0 │  0 │  0 │  0 │  0 │
  └────┴────┴────┴────┴────┴────┘

════════════════════════════════════════════════════════════

ITERATION: left=2, right=2, i=2 (balloon [1])
  coins = 3*1*5 + dp[2][1] + dp[3][2] = 15 + 0 + 0 = 15
  dp[2][2] = max(0, 15) = 15

DP matrix after updating [2][2]:
     0    1    2    3    4    5
  ┌────┬────┬────┬────┬────┬────┐
0 │  0 │  0 │  0 │  0 │  0 │  0 │
  ├────┼────┼────┼────┼────┼────┤
1 │  0 │  0 │  0 │  0 │  0 │  0 │
  ├────┼────┼────┼────┼────┼────┤
2 │  0 │  0 │ 15 │  0 │  0 │  0 │ ← updated
  ├────┼────┼────┼────┼────┼────┤
3 │  0 │  0 │  0 │ 40 │ 48 │  0 │
  ├────┼────┼────┼────┼────┼────┤
4 │  0 │  0 │  0 │  0 │ 40 │  0 │
  ├────┼────┼────┼────┼────┼────┤
5 │  0 │  0 │  0 │  0 │  0 │  0 │
  └────┴────┴────┴────┴────┴────┘

════════════════════════════════════════════════════════════

ITERATION: left=2, right=3 (balloons [1, 5])
  i=2: coins = 3*1*8 + dp[2][1] + dp[3][3] = 24 + 0 + 40 = 64
       dp[2][3] = max(0, 64) = 64
  i=3: coins = 3*5*8 + dp[2][2] + dp[4][3] = 120 + 15 + 0 = 135
       dp[2][3] = max(64, 135) = 135

DP matrix after updating [2][3]:
     0    1    2    3    4    5
  ┌────┬────┬────┬────┬────┬────┐
0 │  0 │  0 │  0 │  0 │  0 │  0 │
  ├────┼────┼────┼────┼────┼────┤
1 │  0 │  0 │  0 │  0 │  0 │  0 │
  ├────┼────┼────┼────┼────┼────┤
2 │  0 │  0 │ 15 │135 │  0 │  0 │ ← updated
  ├────┼────┼────┼────┼────┼────┤
3 │  0 │  0 │  0 │ 40 │ 48 │  0 │
  ├────┼────┼────┼────┼────┼────┤
4 │  0 │  0 │  0 │  0 │ 40 │  0 │
  ├────┼────┼────┼────┼────┼────┤
5 │  0 │  0 │  0 │  0 │  0 │  0 │
  └────┴────┴────┴────┴────┴────┘

════════════════════════════════════════════════════════════

ITERATION: left=2, right=4 (balloons [1, 5, 8])
  i=2: coins = 3*1*1 + dp[2][1] + dp[3][4] = 3 + 0 + 48 = 51
       dp[2][4] = max(0, 51) = 51
  i=3: coins = 3*5*1 + dp[2][2] + dp[4][4] = 15 + 15 + 40 = 70
       dp[2][4] = max(51, 70) = 70
  i=4: coins = 3*8*1 + dp[2][3] + dp[5][4] = 24 + 135 + 0 = 159
       dp[2][4] = max(70, 159) = 159

DP matrix after updating [2][4]:
     0    1    2    3    4    5
  ┌────┬────┬────┬────┬────┬────┐
0 │  0 │  0 │  0 │  0 │  0 │  0 │
  ├────┼────┼────┼────┼────┼────┤
1 │  0 │  0 │  0 │  0 │  0 │  0 │
  ├────┼────┼────┼────┼────┼────┤
2 │  0 │  0 │ 15 │135 │159 │  0 │ ← updated
  ├────┼────┼────┼────┼────┼────┤
3 │  0 │  0 │  0 │ 40 │ 48 │  0 │
  ├────┼────┼────┼────┼────┼────┤
4 │  0 │  0 │  0 │  0 │ 40 │  0 │
  ├────┼────┼────┼────┼────┼────┤
5 │  0 │  0 │  0 │  0 │  0 │  0 │
  └────┴────┴────┴────┴────┴────┘

════════════════════════════════════════════════════════════

ITERATION: left=1, right=1, i=1 (balloon [3])
  coins = 1*3*1 + dp[1][0] + dp[2][1] = 3 + 0 + 0 = 3
  dp[1][1] = max(0, 3) = 3

DP matrix after updating [1][1]:
     0    1    2    3    4    5
  ┌────┬────┬────┬────┬────┬────┐
0 │  0 │  0 │  0 │  0 │  0 │  0 │
  ├────┼────┼────┼────┼────┼────┤
1 │  0 │  3 │  0 │  0 │  0 │  0 │ ← updated
  ├────┼────┼────┼────┼────┼────┤
2 │  0 │  0 │ 15 │135 │159 │  0 │
  ├────┼────┼────┼────┼────┼────┤
3 │  0 │  0 │  0 │ 40 │ 48 │  0 │
  ├────┼────┼────┼────┼────┼────┤
4 │  0 │  0 │  0 │  0 │ 40 │  0 │
  ├────┼────┼────┼────┼────┼────┤
5 │  0 │  0 │  0 │  0 │  0 │  0 │
  └────┴────┴────┴────┴────┴────┘

════════════════════════════════════════════════════════════

ITERATION: left=1, right=2 (balloons [3, 1])
  i=1: coins = 1*3*5 + dp[1][0] + dp[2][2] = 15 + 0 + 15 = 30
       dp[1][2] = max(0, 30) = 30
  i=2: coins = 1*1*5 + dp[1][1] + dp[3][2] = 5 + 3 + 0 = 8
       dp[1][2] = max(30, 8) = 30

DP matrix after updating [1][2]:
     0    1    2    3    4    5
  ┌────┬────┬────┬────┬────┬────┐
0 │  0 │  0 │  0 │  0 │  0 │  0 │
  ├────┼────┼────┼────┼────┼────┤
1 │  0 │  3 │ 30 │  0 │  0 │  0 │ ← updated
  ├────┼────┼────┼────┼────┼────┤
2 │  0 │  0 │ 15 │135 │159 │  0 │
  ├────┼────┼────┼────┼────┼────┤
3 │  0 │  0 │  0 │ 40 │ 48 │  0 │
  ├────┼────┼────┼────┼────┼────┤
4 │  0 │  0 │  0 │  0 │ 40 │  0 │
  ├────┼────┼────┼────┼────┼────┤
5 │  0 │  0 │  0 │  0 │  0 │  0 │
  └────┴────┴────┴────┴────┴────┘

════════════════════════════════════════════════════════════

ITERATION: left=1, right=3 (balloons [3, 1, 5])
  i=1: coins = 1*3*8 + dp[1][0] + dp[2][3] = 24 + 0 + 135 = 159
       dp[1][3] = max(0, 159) = 159
  i=2: coins = 1*1*8 + dp[1][1] + dp[3][3] = 8 + 3 + 40 = 51
       dp[1][3] = max(159, 51) = 159
  i=3: coins = 1*5*8 + dp[1][2] + dp[4][3] = 40 + 30 + 0 = 70
       dp[1][3] = max(159, 70) = 159

DP matrix after updating [1][3]:
     0    1    2    3    4    5
  ┌────┬────┬────┬────┬────┬────┐
0 │  0 │  0 │  0 │  0 │  0 │  0 │
  ├────┼────┼────┼────┼────┼────┤
1 │  0 │  3 │ 30 │159 │  0 │  0 │ ← updated
  ├────┼────┼────┼────┼────┼────┤
2 │  0 │  0 │ 15 │135 │159 │  0 │
  ├────┼────┼────┼────┼────┼────┤
3 │  0 │  0 │  0 │ 40 │ 48 │  0 │
  ├────┼────┼────┼────┼────┼────┤
4 │  0 │  0 │  0 │  0 │ 40 │  0 │
  ├────┼────┼────┼────┼────┼────┤
5 │  0 │  0 │  0 │  0 │  0 │  0 │
  └────┴────┴────┴────┴────┴────┘

════════════════════════════════════════════════════════════

ITERATION: left=1, right=4 (balloons [3, 1, 5, 8]) - ALL BALLOONS
  i=1: coins = 1*3*1 + dp[1][0] + dp[2][4] = 3 + 0 + 159 = 162
       dp[1][4] = max(0, 162) = 162
  i=2: coins = 1*1*1 + dp[1][1] + dp[3][4] = 1 + 3 + 48 = 52
       dp[1][4] = max(162, 52) = 162
  i=3: coins = 1*5*1 + dp[1][2] + dp[4][4] = 5 + 30 + 40 = 75
       dp[1][4] = max(162, 75) = 162
  i=4: coins = 1*8*1 + dp[1][3] + dp[5][4] = 8 + 159 + 0 = 167
       dp[1][4] = max(162, 167) = 167

FINAL DP matrix:
     0    1    2    3    4    5
  ┌────┬────┬────┬────┬────┬────┐
0 │  0 │  0 │  0 │  0 │  0 │  0 │
  ├────┼────┼────┼────┼────┼────┤
1 │  0 │  3 │ 30 │159 │167 │  0 │ ← dp[1][4] is the answer!
  ├────┼────┼────┼────┼────┼────┤
2 │  0 │  0 │ 15 │135 │159 │  0 │
  ├────┼────┼────┼────┼────┼────┤
3 │  0 │  0 │  0 │ 40 │ 48 │  0 │
  ├────┼────┼────┼────┼────┼────┤
4 │  0 │  0 │  0 │  0 │ 40 │  0 │
  ├────┼────┼────┼────┼────┼────┤
5 │  0 │  0 │  0 │  0 │  0 │  0 │
  └────┴────┴────┴────┴────┴────┘

Return dp[1][4] = 167 ✓

The DP table fills bottom-up diagonally:
- Single balloons first (diagonal): [4][4], [3][3], [2][2], [1][1]
- Then pairs: [3][4], [2][3], [1][2]
- Then triples: [2][4], [1][3]
- Finally all four: [1][4]
"""
